
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>philcrissman.com</title>
	<meta name="author" content="Phil Crissman">

	
	<meta name="description" content="So, let&#8217;s say you have a model, and a has_many relationship to another model. You want to accept nested attributes for the child models in &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="philcrissman.com" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>

<body>
	<header id="header" class="inner"><h1><a href="/">philcrissman.com</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:philcrissman.com">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
    
		<a class="appdotnet" href="http://alpha.app.net/philcrissman" title="App.net">App.net</a>
    
		
		
		<a class="google" href="https://plus.google.com/115225600632800161143?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/philcrissman" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/philcrissman" title="GitHub">GitHub</a>
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:philcrissman.com">
	</form>
</nav>

</header>
	
		<!-- ad -->


<!-- <div id="banner" class="inner"> -->
	<!-- <div class="container"> -->
	<!-- 	<ul class="feed"></ul> -->
	<!-- </div> -->
	<!-- <small><a href="http://twitter.com/philcrissman">philcrissman</a> @ <a href="http://twitter.com">Twitter</a></small> -->
	<!-- <div class="loading">Loading...</div> -->
<!-- </div> -->
<!-- <script src="/javascripts/twitter.js"></script> -->
<!-- <script type="text/javascript"> -->
<!-- 	(function($){ -->
<!-- 		$('#banner').getTwitterFeed('philcrissman', 4, false); -->
<!-- 	})(jQuery); -->
<!-- </script> -->


	
	<div id="content" class="inner">


    <article class="post">
	<h1 class="title"><a href="/2010/04/12/validating-nested-attributes-on-update/">Validating Nested Attributes on Update</a></h1>
	<div class="entry-content">
		<p>So, let&#8217;s say you have a model, and a has_many relationship to another model. You want to accept nested attributes for the child models in your forms, and you also want to validate that the children must be present; the parent model can&#8217;t be saved unless it has <em>at least one</em> of the child model associated. Easy enough, right?</p>

<figure class='code'><figcaption><span>parent.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">Parent</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:children</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">accepts_nested_attributes_for</span> <span class="ss">:children</span><span class="p">,</span> <span class="ss">:allow_destroy</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">validates_presence_of</span> <span class="ss">:children</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Child</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:parent</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s not too bad. But the thing is, this will validate presence of the children on create, but not on update&#8230;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;&gt;</span> <span class="nb">p</span> <span class="o">=</span> <span class="no">Parent</span><span class="o">.</span><span class="n">new</span> <span class="c1"># note: no children</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&amp;lt;Parent id:nil ... &gt;</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="nb">p</span><span class="o">.</span><span class="n">save!</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1"># errors glaore</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="n">p2</span> <span class="o">=</span> <span class="no">Parent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="ss">:last</span><span class="p">)</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&amp;lt;Parent id:23 ... &gt;</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="n">p2</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="s2">&quot;childen_attributes&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s2">&quot;0&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:_destroy</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">},</span> <span class="o">[.</span><span class="n">.</span><span class="o">.</span> <span class="n">etc</span><span class="o">.</span> <span class="no">Assume</span> <span class="n">all</span> <span class="n">children</span> <span class="n">are</span> <span class="n">sent</span> <span class="n">a</span> <span class="n">destroy</span> <span class="n">flag</span> <span class="n">here</span><span class="o">]</span><span class="p">})</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">true</span> <span class="c1"># what! it saved?</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="n">p2</span><span class="o">.</span><span class="n">valid?</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="kp">false</span> <span class="c1"># what! it&#39;s saved, but not valid anymore... (because it has no children)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, the trouble is (I think), when you save the existing Parent, at the moment validation is checked, there are still children. They won&#8217;t be deleted until .save is called. So the object is valid. Then after it&#8217;s saved, the children have been deleted, and the object is saved, but it is no longer valid. What to do?</p>

<p>Well, after some pondering, I wound up with this (in the update method):</p>

<figure class='code'><figcaption><span>parents_controller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">ParentsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="c1"># other methods...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">update</span>
</span><span class='line'>    <span class="vi">@parent</span> <span class="o">=</span> <span class="no">Parent</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># assign the attributes _without trying to save_</span>
</span><span class='line'>    <span class="vi">@parent</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:parent</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># this line winds up as true if all items are marked for deletion; otherwise, false</span>
</span><span class='line'>    <span class="n">reject</span> <span class="o">=</span> <span class="vi">@parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="kp">true</span><span class="p">){</span><span class="o">|</span><span class="n">truthiness</span><span class="p">,</span> <span class="n">n</span><span class="o">|</span> <span class="o">!!</span><span class="p">(</span><span class="n">truthiness</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">.</span><span class="n">marked_for_destruction?</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># check reject&#39;s truthiness first. Only try to save if reject is false. </span>
</span><span class='line'>    <span class="c1"># If we save first, it will save even though items will all be deleted.</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="n">reject</span> <span class="o">&amp;&amp;</span> <span class="vi">@parent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:order_form</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Object updated&quot;</span>
</span><span class='line'>      <span class="n">redirect_to</span> <span class="n">parent_path</span><span class="p">(</span><span class="vi">@parent</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Object could not be saved&quot;</span>
</span><span class='line'>      <span class="n">render</span> <span class="ss">:action</span> <span class="o">=&gt;</span> <span class="ss">:edit</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, checking for an objects validity in the controller seems wrong to me, too, but it works. Anyone who has run into this find another way to do it?</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2010-04-12T00:00:00-05:00" pubdate data-updated="true">Apr 12<span>th</span>, 2010</time></div>
	<div class="tags">

</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/2010/04/01/xwing/">Xwing</a></h1>
	<div class="entry-content">
		<p><img src="http://philcrissman.com/images/B0CsT.jpg" width="440" /></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2010-04-01T00:00:00-05:00" pubdate data-updated="true">Apr 1<span>st</span>, 2010</time></div>
	<div class="tags">

</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/2010/04/01/oracle-to-acquire-oracle/">Oracle to Acquire Oracle</a></h1>
	<div class="entry-content">
		<p>REDWOOD SHORES &#8211; Oracle is rumored to have lined up yet another in a long string of billion dollar acquisitions, and this time they have set their sights on their very own corporation. No one from Oracle has been willing to make an official statement regarding the rumors, but the news has been spreading throughout Silicon Valley.</p>

<p>Oracle, currently worth an estimated 47 billion USD, is a market leader in enterprise software, known particularly for their database product. Industry analysts admit that a corporation buying itself outright is unprecedented, but that, &#8220;As a strategic move, it makes a great deal of sense.&#8221; Enterprise consultant Robert Forsythe comments, &#8220;At this point, there are not a whole lot of other companies for Oracle to acquire. Purchasing themselves provides a creative way around this dilemma. Also, adding Oracle&#8217;s stellar sales staff to their already exhaustive line of software products is sure to be a winning combination.&#8221; Forsythe added, &#8220;I would predict that the shareholders will be happy to hear this rumor confirmed in the near future.&#8221;</p>

<p>Not all industry analysts are quite so certain. &#8220;Rumors fly all over Silicon Valley on a regular basis,&#8221; said veteran Valley analyst Pratik Singh. &#8220;This is just the latest in a long line of the same. Could Oracle buy Oracle? Well, sure they could. They certainly have the capital to do so, and are in a better position than anyone else to know the details of Oracle&#8217;s business and strategy. But I fear this will only end up much like last year&#8217;s rumored acquisition of software giant Microsoft, by software giant Microsoft. That had everyone&#8217;s heads turning as well.&#8221; Pratik added, &#8220;Of course, no one in the press bothered to pay attention to the fact that this would have been a terrible acquisition.&#8221;</p>

<p>When questioned about the apparent contradiction inherent to the rumors, Forsythe said, &#8220;Sure, industry outsiders might ask questions like, <em>why would Oracle buy themselves? Don&#8217;t they already own themselves?</em>&#8221; Forsythe paused to allow himself a knowing chuckle. &#8220;But that just betrays a lack of understanding of how things work in the Valley.&#8221;</p>

<p>Indeed, acquisitions in and around Silicon Valley have a long and convoluted history, especially Oracle&#8217;s own long list of corporate purchases. Just last year, Oracle announced a purchase of BEA Software, an announcement which was hastily retracted when it was discovered that Oracle had already purchased BEA Software the previous fiscal year.</p>

<p>Even the skeptical Singh notes, &#8220;Oracle does have some of the brightest business minds in the world on their payroll. It would be irresponsible to assume that they have not considered the possibility of an acquisition of Oracle, by Oracle, and that they would not have made some detailed projections on the possible results of such a transaction. If they believed it would be a positive move for the shareholders, well, of course, every consideration would be made and Oracle would ultimately make the decision that is best for itself, it&#8217;s shareholders and its customers and other stakeholders.&#8221;</p>

<p>Regardless of the many and varied opinions put forth by the industry pundits, the rumors continue to gain momentum, and Oracle&#8217;s stock price has indeed jumped several points by close of business yesterday as a result.</p>

<p>Oracle&#8217;s CEO, Larry Ellison, also refused to comment directly on the rumors, saying only, &#8220;I&#8217;m Larry f@#$ing Ellison, I&#8217;ll buy whatever the f@#$ I want to,&#8221; before threatening members of the press corps with disembowelment at the hands of his samurai bodyguards.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2010-04-01T00:00:00-05:00" pubdate data-updated="true">Apr 1<span>st</span>, 2010</time></div>
	<div class="tags">

</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/2010/03/23/here-are-the-news/">Here Are the News</a></h1>
	<div class="entry-content">
		<p>This is simply awesome.</p>

<object width="640" height="385"><param name="movie" value="http://www.youtube.com/v/YtGSXMuWMR4&color1=0xb1b1b1&color2=0xcfcfcf&hl=en_US&feature=player_embedded&fs=1"></param><param name="allowFullScreen" value="true"></param><param name="allowScriptAccess" value="always"></param><embed src="http://www.youtube.com/v/YtGSXMuWMR4&color1=0xb1b1b1&color2=0xcfcfcf&hl=en_US&feature=player_embedded&fs=1" type="application/x-shockwave-flash" allowfullscreen="true" allowScriptAccess="always" width="425" height="385"></embed></object>


<p>Courtesy <a href="http://misener.org/archives/618">Dan Misener</a>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2010-03-23T00:00:00-05:00" pubdate data-updated="true">Mar 23<span>rd</span>, 2010</time></div>
	<div class="tags">

</div>
	
</div></article>


    <article class="post">
	<h1 class="title"><a href="/2010/02/28/hello-toto/">Hello Toto</a></h1>
	<div class="entry-content">
		<p>Moving this blog over to Toto. I did not move all the posts, but I don&#8217;t think there&#8217;s a big loss for the ones I neglected, and you can alway spend time looking for cached or archived pages if it Really Matters. Sorry.</p>

<p>Was having some trouble getting the feed to worked automagically, we&#8217;ll see what has happened there when it goes live.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2010-02-28T00:00:00-06:00" pubdate data-updated="true">Feb 28<span>th</span>, 2010</time></div>
	<div class="tags">

</div>
	
</div></article>

<nav id="pagenavi">
    
        <a href="/blog/page/8/" class="prev">Prev</a>
    
    
        <a href="/blog/page/10/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2012

    Phil Crissman

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-77047-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>